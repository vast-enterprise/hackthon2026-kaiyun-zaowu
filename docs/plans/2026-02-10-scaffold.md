# 项目脚手架搭建 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 搭建八字吉祥物 3D 生成应用的项目基础框架，让所有目录结构、依赖、配置就位，可以开始功能开发。

**Architecture:** Next.js App Router 全栈应用，前端使用 Tailwind + shadcn/ui + react-three-fiber，后端使用 API Routes 代理第三方服务。现有的 docs/ 和 scripts/ 目录保留。

**Tech Stack:** Next.js, TypeScript, Tailwind CSS, shadcn/ui, react-three-fiber, three.js, pnpm, @antfu/eslint-config

---

### Task 0: Git 初始化

**Step 1: 初始化 Git 仓库并提交现有文件**

```bash
cd /Users/macbookair/Desktop/projects/tripo-bagua
git init
git remote add origin https://github.com/gkn1234/tripo-bagua.git
git add -A
git commit -m "chore: init repo with api research docs"
```

---

### Task 1: 初始化 Next.js 项目

**Files:**
- Create: `package.json`, `tsconfig.json`, `next.config.ts`, `tailwind.config.ts`, `postcss.config.mjs`, `app/layout.tsx`, `app/page.tsx`

**Step 1: 在现有目录初始化 Next.js**

```bash
cd /Users/macbookair/Desktop/projects/tripo-bagua
pnpm dlx create-next-app@latest . --typescript --tailwind --eslint --app --no-src-dir --import-alias "@/*" --use-pnpm
```

注意：当前目录已有 `docs/`、`scripts/`、`secret`，create-next-app 会跳过已有文件，不冲突。如果提示覆盖则选否。

**Step 2: 替换 ESLint 配置为 @antfu/eslint-config**

```bash
pnpm remove eslint-config-next
pnpm add -D @antfu/eslint-config @next/eslint-plugin-next
```

删除 `.eslintrc.json`（如果存在），创建 `eslint.config.mjs`：

```js
import antfu from '@antfu/eslint-config'

export default antfu({
  react: true,
  typescript: true,
  nextjs: true,
})
```

更新 `package.json` scripts，添加：

```json
{
  "scripts": {
    "lint": "eslint .",
    "lint:fix": "eslint . --fix"
  }
}
```

创建 `.vscode/settings.json`：

```json
{
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": "explicit",
    "source.organizeImports": "never"
  },
  "editor.formatOnSave": false,
  "eslint.experimental.useFlatConfig": true,
  "prettier.enable": false,
  "eslint.validate": [
    "javascript",
    "javascriptreact",
    "typescript",
    "typescriptreact",
    "json",
    "jsonc",
    "markdown"
  ]
}
```

**Step 3: 验证项目能启动**

```bash
pnpm dev
```

Expected: 终端输出 `Ready` + 本地地址，浏览器访问能看到 Next.js 默认页面。

**Step 4: 运行 lint 并修复默认模板的 lint 问题**

```bash
pnpm lint:fix
```

Expected: @antfu/eslint-config 会自动修复代码风格（如单引号、无分号等）。

**Step 5: 停止 dev server，Commit**

```bash
echo "node_modules/" >> .gitignore
echo ".env.local" >> .gitignore
echo "secret" >> .gitignore
git add -A
git commit -m "chore: init next.js project with typescript, tailwind, antfu eslint"
```

---

### Task 2: 安装核心依赖

**Files:**
- Modify: `package.json`

**Step 1: 安装 3D 相关依赖**

```bash
pnpm add three @react-three/fiber @react-three/drei
pnpm add -D @types/three
```

**Step 2: 安装 shadcn/ui**

```bash
pnpm dlx shadcn@latest init -d
```

选择默认配置（New York style, Zinc color, CSS variables: yes）。

**Step 3: 添加需要的 shadcn 组件**

```bash
pnpm dlx shadcn@latest add button dialog input select scroll-area label textarea
```

**Step 4: 运行 lint:fix 修复新文件的代码风格**

```bash
pnpm lint:fix
```

**Step 5: 验证依赖安装正确**

```bash
pnpm build
```

Expected: 构建成功，无错误。

**Step 6: Commit**

```bash
git add -A
git commit -m "chore: add three.js, react-three-fiber, shadcn/ui dependencies"
```

---

### Task 3: 创建目录结构和占位文件

**Files:**
- Create: `components/chat/index.tsx`
- Create: `components/model-viewer/index.tsx`
- Create: `components/order-modal/index.tsx`
- Create: `lib/bazi/index.ts`
- Create: `lib/deepseek.ts`
- Create: `lib/tripo.ts`
- Create: `lib/shop.ts`

**Step 1: 创建组件占位**

`components/chat/index.tsx`:
```tsx
'use client'

export function Chat({ onModelReady }: { onModelReady: (modelUrl: string) => void }) {
  return (
    <div className="flex h-full flex-col">
      <div className="flex-1 overflow-y-auto p-4">
        {/* 消息列表 */}
      </div>
      <div className="border-t p-4">
        {/* 输入框 */}
      </div>
    </div>
  )
}
```

`components/model-viewer/index.tsx`:
```tsx
'use client'

import { OrbitControls, Stage } from '@react-three/drei'
import { Canvas } from '@react-three/fiber'

export function ModelViewer({ modelUrl }: { modelUrl: string }) {
  return (
    <div className="h-full w-full">
      <Canvas>
        <Stage>
          {/* GLB 模型加载 */}
        </Stage>
        <OrbitControls />
      </Canvas>
    </div>
  )
}
```

`components/order-modal/index.tsx`:
```tsx
'use client'

import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog'

export function OrderModal({
  open,
  onOpenChange,
  modelUrl,
}: {
  open: boolean
  onOpenChange: (open: boolean) => void
  modelUrl: string
}) {
  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>下单打印</DialogTitle>
        </DialogHeader>
        {/* 下单表单 */}
      </DialogContent>
    </Dialog>
  )
}
```

**Step 2: 创建 lib 占位**

`lib/bazi/index.ts`:
```ts
export interface BaziResult {
  eightCharacters: string // 八字
  fiveElements: string // 五行
  favorableElement: string // 喜用神
  analysis: string // 分析描述
}

export function calculateBazi(year: number, month: number, day: number, hour: number): BaziResult {
  // TODO: 实现八字计算
  throw new Error('Not implemented')
}
```

`lib/deepseek.ts`:
```ts
const DEEPSEEK_API_KEY = process.env.DEEPSEEK_API_KEY!
const DEEPSEEK_BASE_URL = process.env.DEEPSEEK_BASE_URL || 'https://api.deepseek.com'

export async function* chatStream(messages: Array<{ role: string, content: string }>) {
  // TODO: 实现 DeepSeek 流式调用 + tool calling
  throw new Error('Not implemented')
}
```

`lib/tripo.ts`:
```ts
const TRIPO_API_KEY = process.env.TRIPO_API_KEY!

export async function createTextToModelTask(prompt: string) {
  // TODO: 实现 Tripo 文生3D
  throw new Error('Not implemented')
}

export async function getTaskStatus(taskId: string) {
  // TODO: 实现任务状态查询
  throw new Error('Not implemented')
}
```

`lib/shop.ts`:
```ts
const SHOP_API_KEY = process.env.SHOP_API_KEY!

export interface OrderParams {
  dimensions: string
  category: string
  quantity: number
  finishType: string
  contactPerson: string
  contactPhone: string
  shippingAddress: string
  country: string
  modelFileUrl: string
  baseEngraving?: string
}

export async function createOrder(params: OrderParams) {
  // TODO: 实现 Shop 中台下单
  throw new Error('Not implemented')
}
```

**Step 3: 运行 lint:fix**

```bash
pnpm lint:fix
```

**Step 4: Commit**

```bash
git add -A
git commit -m "chore: add component and lib placeholders"
```

---

### Task 4: 创建 API Routes 骨架

**Files:**
- Create: `app/api/chat/route.ts`
- Create: `app/api/tripo/generate/route.ts`
- Create: `app/api/tripo/task/[id]/route.ts`
- Create: `app/api/order/route.ts`

**Step 1: 创建 API Route 占位**

`app/api/chat/route.ts`:
```ts
import type { NextRequest } from 'next/server'

export async function POST(req: NextRequest) {
  // TODO: DeepSeek 流式对话 + tool calling
  return new Response('Not implemented', { status: 501 })
}
```

`app/api/tripo/generate/route.ts`:
```ts
import type { NextRequest } from 'next/server'

export async function POST(req: NextRequest) {
  // TODO: 提交 Tripo 文生3D 任务
  return new Response('Not implemented', { status: 501 })
}
```

`app/api/tripo/task/[id]/route.ts`:
```ts
import type { NextRequest } from 'next/server'

export async function GET(
  req: NextRequest,
  { params }: { params: Promise<{ id: string }> },
) {
  // TODO: 查询 Tripo 任务状态
  return new Response('Not implemented', { status: 501 })
}
```

`app/api/order/route.ts`:
```ts
import type { NextRequest } from 'next/server'

export async function POST(req: NextRequest) {
  // TODO: 创建 Shop 中台订单
  return new Response('Not implemented', { status: 501 })
}
```

**Step 2: 运行 lint:fix**

```bash
pnpm lint:fix
```

**Step 3: Commit**

```bash
git add -A
git commit -m "chore: add api route skeletons"
```

---

### Task 5: 搭建主页面布局（两阶段切换）

**Files:**
- Modify: `app/page.tsx`
- Modify: `app/layout.tsx`

**Step 1: 更新 layout.tsx**

`app/layout.tsx` — 清理默认样式，设置中文 lang：
```tsx
import type { Metadata } from 'next'
import { Inter } from 'next/font/google'
import './globals.css'

const inter = Inter({ subsets: ['latin'] })

export const metadata: Metadata = {
  title: '八字吉祥物 3D 生成',
  description: '输入生辰八字，AI 生成专属吉祥物 3D 模型',
}

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode
}>) {
  return (
    <html lang="zh-CN">
      <body className={inter.className}>{children}</body>
    </html>
  )
}
```

**Step 2: 实现主页面两阶段布局**

`app/page.tsx`:
```tsx
'use client'

import { useState } from 'react'
import { Chat } from '@/components/chat'
import { ModelViewer } from '@/components/model-viewer'
import { OrderModal } from '@/components/order-modal'
import { Button } from '@/components/ui/button'

export default function Home() {
  const [modelUrl, setModelUrl] = useState<string | null>(null)
  const [orderModalOpen, setOrderModalOpen] = useState(false)

  // 阶段一：对话全屏
  if (!modelUrl) {
    return (
      <main className="h-screen">
        <Chat onModelReady={setModelUrl} />
      </main>
    )
  }

  // 阶段二：对话半屏 + 3D 工作台半屏
  return (
    <main className="flex h-screen">
      <div className="w-1/2 border-r">
        <Chat onModelReady={setModelUrl} />
      </div>
      <div className="relative w-1/2">
        <ModelViewer modelUrl={modelUrl} />
        <div className="absolute bottom-6 left-1/2 -translate-x-1/2">
          <Button size="lg" onClick={() => setOrderModalOpen(true)}>
            下单打印
          </Button>
        </div>
      </div>
      <OrderModal
        open={orderModalOpen}
        onOpenChange={setOrderModalOpen}
        modelUrl={modelUrl}
      />
    </main>
  )
}
```

**Step 3: 运行 lint:fix + 验证构建**

```bash
pnpm lint:fix
pnpm build
```

Expected: 构建成功。

**Step 4: Commit**

```bash
git add -A
git commit -m "feat: scaffold main page with two-phase layout"
```

---

### Task 6: 环境变量模板

**Files:**
- Create: `.env.example`

**Step 1: 创建环境变量模板**

`.env.example`:
```
# DeepSeek
DEEPSEEK_API_KEY=
DEEPSEEK_BASE_URL=https://api.deepseek.com

# Tripo 文生3D
TRIPO_API_KEY=

# Shop 中台
SHOP_API_KEY=
```

**Step 2: Commit**

```bash
git add .env.example
git commit -m "chore: add env variables template"
```

---

### 完成标准

- [ ] `pnpm dev` 能启动，浏览器可见对话全屏页面
- [ ] `pnpm build` 无错误
- [ ] `pnpm lint` 无报错
- [ ] 目录结构与设计文档一致
- [ ] 所有第三方 API Key 通过环境变量读取
- [ ] `secret` 文件在 `.gitignore` 中

# 八字聊天交互体验优化设计

## 概述

将当前一口气完成排盘+分析+吉祥物的流程，改为分步引导式交互。从提示词、工具、前端交互三个维度综合优化。

## 设计决策

| 决策项 | 选择 | 理由 |
|--------|------|------|
| 提示词语言 | 全中文 | DeepSeek 是中文原生模型，八字是中国文化领域 |
| AI 人设 | 年轻犀利、铁口直断 | 直接给结论，不兜圈子，轻松但不油滑 |
| 引导机制 | AI 驱动（非状态机） | AI 天然了解对话上下文，由它决定引导内容最自然 |
| 选项交互 | `presentOptions` 工具调用 | 复用现有 tool → 自定义组件渲染管线，零架构改动 |
| 吉祥物迭代 | 小改 retexture + 大改重新生成 | Tripo 支持 retexture API，结合使用覆盖所有场景 |
| 流程风格 | 原则驱动 | 用行为准则引导 AI，不用伪代码描述状态转移 |

## 对话流程

```
确认生辰 → 排盘+概览 → 分支选择
                         ├→ 深入解读（可多轮）→ 适时提醒吉祥物
                         └→ 吉祥物流程
                              ├→ 讨论喜好风格
                              ├→ 确认方案 → 生成
                              └→ 不满意 → 讨论 → 确认 → 小改(retexture)/大改(重新生成) → 循环
```

核心节奏：`讨论 → 确认 → 执行 → 评价 → 讨论 → ...`

## 工具定义变更

### 保留（描述改为中文）

- **analyzeBazi** — 八字排盘，参数不变（year/month/day/hour/gender）
- **generateMascot** — 3D 模型生成，参数不变（prompt/style）

### 新增

- **presentOptions** — 向用户展示可选项，引导下一步操作
  - 参数：`options: Array<{ label: string, description?: string }>`
  - execute 直传前端渲染，不做业务逻辑
  - 前端检测 `tool-presentOptions` + `output-available` 后渲染按钮组
  - 用户点击按钮 → 以 label 文本作为新消息发送

- **retextureMascot** — 对已生成模型换材质/风格
  - 参数：`taskId: string`（原模型）、`prompt: string`（新风格描述）
  - 调用 Tripo retexture API
  - 完成后回到讨论环节确认满意度

## 系统提示词（完整）

```
## 你是谁

你是一位年轻但眼光毒辣的命理师。
你的风格是铁口直断——看到什么说什么，不兜圈子，不堆砌术语故作高深。
该夸的地方一笔带过，该提醒的地方绝不含糊。
你说话轻松直接，偶尔带点幽默，但从不油滑。
用户找你，是想听真话，不是听客套。

## 怎么做事

你遵循以下原则：

- 一次只做一件事。做完当前这步，停下来，让用户决定下一步。
- 动手之前先开口。任何生成操作（排盘、生成模型、换材质）前，先描述你打算做什么，等用户确认。
- 给选择不给指令。需要用户做决定时，调用 presentOptions 提供选项，让用户主导节奏。
- 改完不急着收工。每次生成或修改完成后，先问满不满意。不满意就接着聊怎么改，聊完确认了再动手。
- 用户说了生辰信息，先复述确认（年月日时、性别），确认无误后再调用 analyzeBazi。
- 拿到命盘后，先给一个简洁有力的总体判断（两三句话，铁口直断），然后引导用户选择感兴趣的方向或直接看吉祥物。
- 解读具体方向时，结合命盘数据说人话，让没有命理基础的人也能听懂。解读完一个方向后，继续提供选择。
- 吉祥物方案在生成前必须和用户充分讨论——你先推荐，用户可以提自己的想法，最终方案双方都满意了才生成。

## 八字解读

拿到 analyzeBazi 返回的命盘数据后，你的解读方式：

总论先行：观察日主强弱、格局高低，用一两句直白的话概括此人命盘的核心特征。
比如"你这盘日主偏弱但有根，属于看着温和、骨子里倔的人"，而不是"日主甲木生于申月处死地"。

分方向解读时，围绕以下维度展开：
- 事业：看官杀、印星与日主的关系，结合大运走势
- 财运：看财星旺衰、是否有食伤生财的通路
- 婚恋：看配偶宫（日支）、配偶星（男看财女看官）的状态
- 健康：看五行偏枯，哪个五行过旺或过弱对应的身体部位

解读时直接给结论，再简单解释依据。不要先铺垫半天再说结论。

## 吉祥物设计

根据命盘喜用神对应的五行，推荐吉祥物方向：
- 喜水：玄武、龟、鱼 — 黑色/深蓝色调
- 喜木：青龙、麒麟 — 绿色/青色调
- 喜火：朱雀、凤凰 — 红色/橙色调
- 喜金：白虎、貔貅 — 白色/金色调
- 喜土：黄龙、瑞兽 — 黄色/棕色调

描述吉祥物时要具体：造型、姿态、配饰、颜色、材质质感都要说清楚。
风格适合做桌面摆件，精致小巧。
先推荐你认为最合适的方案，再问用户的偏好和想法。

## 工具使用

analyzeBazi — 用户确认生辰信息后调用，不要在用户还没确认时就急着排盘。

presentOptions — 每次回复末尾如果存在分支选择，就调用此工具提供选项按钮。不要用纯文字罗列选项来替代它。

generateMascot — 仅在用户明确确认吉祥物方案后调用。prompt 参数要包含详细的造型描述（形态、颜色、姿态、配饰、材质），用英文描述以获得最佳生成效果。

retextureMascot — 用户对已生成的模型想做小范围调整（换颜色、换材质、换纹理风格）时使用，不改变造型。prompt 参数用英文描述期望的纹理效果（如 "golden metallic surface" 或 "ice blue translucent jade"）。调整完成后回到讨论环节，确认满意度。
```

## 前端变更

### 新增组件

- **OptionsButtons** — 渲染 `presentOptions` 工具输出的选项按钮组
  - 位置：`components/chat/options-buttons.tsx`
  - 检测 `tool-presentOptions` + `output-available`，从 `output.options` 提取选项
  - 渲染为水平排列的按钮组
  - 点击后调用 `sendMessage(label)` 发送用户消息
  - 发送后按钮置灰（防止重复点击）

### 修改文件

- **`app/api/chat/route.ts`**
  - 替换 systemPrompt 为新的中文提示词
  - 工具描述和参数描述改为中文
  - 新增 `presentOptions` 和 `retextureMascot` 工具定义
  - `retextureMascot` 需调用 Tripo retexture API

- **`components/chat/chat-message.tsx`**
  - 在 parts 路由中新增 `tool-presentOptions` → `OptionsButtons` 分支
  - 新增 `tool-retextureMascot` → 复用 `ModelPreview` 分支（或新建组件）
  - 更新 `TOOL_TITLES` 映射表

- **`lib/tripo.ts`**
  - 新增 `retextureTask(originalTaskId, prompt)` 方法，调用 Tripo retexture API

## 不涉及的变更

- 不改 useChat 封装逻辑
- 不改 Zustand store 结构
- 不改 IndexedDB 持久化逻辑
- 不改 Streamdown 渲染器配置
- 不新增前端状态机
